<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¨è½¯Claudeç”¨é‡æ£€æµ‹ - æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-name {
            font-weight: 500;
            color: #333;
        }

        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .test-status.pass {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .test-status.fail {
            background: #ffebee;
            color: #c62828;
        }

        .test-status.pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .test-output {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn.secondary {
            background: #666;
        }

        .summary {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }

        .summary .pass-count {
            color: #2e7d32;
            font-weight: bold;
        }

        .summary .fail-count {
            color: #c62828;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å¨è½¯Claudeç”¨é‡æ£€æµ‹ - æµ‹è¯•å¥—ä»¶</h1>

        <div class="test-section">
            <h2>ğŸ”§ åŠŸèƒ½æµ‹è¯•</h2>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ® äº¤äº’æµ‹è¯•</h2>
            <button class="btn" onclick="simulateMessage()">æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯</button>
            <button class="btn" onclick="simulateRateLimit()">æ¨¡æ‹Ÿè§¦å‘é™åˆ¶</button>
            <button class="btn" onclick="simulateReset()">æ¨¡æ‹Ÿé™åˆ¶æ¢å¤</button>
            <button class="btn secondary" onclick="resetAllTests()">é‡ç½®æ‰€æœ‰æµ‹è¯•</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“ æµ‹è¯•è¾“å‡º</h2>
            <div class="test-output" id="test-output">[ç­‰å¾…æµ‹è¯•æ‰§è¡Œ...]</div>
        </div>

        <div class="summary" id="summary"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿ GM å‡½æ•°
        const storage = {};
        window.GM_getValue = (key, def) => storage[key] ?? def;
        window.GM_setValue = (key, val) => { storage[key] = val; };
        window.GM_notification = (opts) => { log(`[é€šçŸ¥] ${opts.title}: ${opts.text}`); };
        window.GM_addStyle = (css) => {
            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        };

        let testResults = [];
        let outputLog = [];

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            outputLog.push(`[${time}] ${msg}`);
            document.getElementById('test-output').textContent = outputLog.join('\n');
            document.getElementById('test-output').scrollTop = document.getElementById('test-output').scrollHeight;
        }

        function addTestResult(name, passed, details = '') {
            testResults.push({ name, passed, details });
            renderResults();
        }

        function renderResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(t => `
                <div class="test-item">
                    <span class="test-name">${t.name}</span>
                    <span class="test-status ${t.passed ? 'pass' : 'fail'}">${t.passed ? 'é€šè¿‡' : 'å¤±è´¥'}</span>
                </div>
            `).join('');

            const passed = testResults.filter(t => t.passed).length;
            const failed = testResults.filter(t => !t.passed).length;
            document.getElementById('summary').innerHTML = `
                æµ‹è¯•å®Œæˆ: <span class="pass-count">${passed} é€šè¿‡</span> / <span class="fail-count">${failed} å¤±è´¥</span>
            `;
        }

        // ==================== æµ‹è¯•ç”¨ä¾‹ ====================

        // æµ‹è¯•1: å·¥å…·å‡½æ•°
        function testUtils() {
            log('å¼€å§‹æµ‹è¯•å·¥å…·å‡½æ•°...');

            // æµ‹è¯•æ—¶é—´æ ¼å¼åŒ–
            const testDate = new Date('2024-01-15T10:30:45');
            const formatted = testDate.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const pass1 = formatted.includes('01') && formatted.includes('15');
            addTestResult('æ—¶é—´æ ¼å¼åŒ–å‡½æ•°', pass1);
            log(`æ—¶é—´æ ¼å¼åŒ–æµ‹è¯•: ${formatted} - ${pass1 ? 'é€šè¿‡' : 'å¤±è´¥'}`);

            // æµ‹è¯•æ—¶é•¿æ ¼å¼åŒ–
            const duration1 = 3661000; // 1å°æ—¶1åˆ†é’Ÿ1ç§’
            const hours = Math.floor(duration1 / (1000 * 60 * 60));
            const minutes = Math.floor((duration1 % (1000 * 60 * 60)) / (1000 * 60));
            const pass2 = hours === 1 && minutes === 1;
            addTestResult('æ—¶é•¿æ ¼å¼åŒ–å‡½æ•°', pass2);
            log(`æ—¶é•¿æ ¼å¼åŒ–æµ‹è¯•: ${hours}å°æ—¶${minutes}åˆ†é’Ÿ - ${pass2 ? 'é€šè¿‡' : 'å¤±è´¥'}`);

            return pass1 && pass2;
        }

        // æµ‹è¯•2: å­˜å‚¨åŠŸèƒ½
        function testStorage() {
            log('å¼€å§‹æµ‹è¯•å­˜å‚¨åŠŸèƒ½...');

            const testKey = 'test_key';
            const testValue = { count: 42, name: 'test' };

            GM_setValue(testKey, JSON.stringify(testValue));
            const retrieved = JSON.parse(GM_getValue(testKey, null));

            const pass = retrieved && retrieved.count === 42 && retrieved.name === 'test';
            addTestResult('æœ¬åœ°å­˜å‚¨åŠŸèƒ½', pass);
            log(`å­˜å‚¨æµ‹è¯•: ${JSON.stringify(retrieved)} - ${pass ? 'é€šè¿‡' : 'å¤±è´¥'}`);

            return pass;
        }

        // æµ‹è¯•3: ç”¨é‡æ•°æ®ç»“æ„
        function testUsageDataStructure() {
            log('å¼€å§‹æµ‹è¯•ç”¨é‡æ•°æ®ç»“æ„...');

            const usageData = {
                isLimited: false,
                limitDetectedAt: null,
                estimatedResetTime: null,
                messageCount: 0,
                sessionStartTime: Date.now(),
                dailyStats: {},
                lastCheckTime: null,
                limitType: null,
                limitMessage: ''
            };

            const requiredFields = [
                'isLimited', 'limitDetectedAt', 'estimatedResetTime',
                'messageCount', 'sessionStartTime', 'dailyStats',
                'lastCheckTime', 'limitType', 'limitMessage'
            ];

            const pass = requiredFields.every(field => field in usageData);
            addTestResult('ç”¨é‡æ•°æ®ç»“æ„å®Œæ•´æ€§', pass);
            log(`æ•°æ®ç»“æ„æµ‹è¯•: ${requiredFields.length}ä¸ªå­—æ®µ - ${pass ? 'é€šè¿‡' : 'å¤±è´¥'}`);

            return pass;
        }

        // æµ‹è¯•4: é™åˆ¶æ£€æµ‹é€»è¾‘
        function testLimitDetection() {
            log('å¼€å§‹æµ‹è¯•é™åˆ¶æ£€æµ‹é€»è¾‘...');

            const limitPatterns = [
                /you('ve| have) (reached|hit|exceeded)/i,
                /rate limit/i,
                /too many (requests|messages)/i,
                /usage limit/i,
                /please (wait|try again)/i
            ];

            const testMessages = [
                { text: "You've reached your usage limit", shouldMatch: true },
                { text: "Rate limit exceeded", shouldMatch: true },
                { text: "Too many messages sent", shouldMatch: true },
                { text: "Please try again later", shouldMatch: true },
                { text: "Hello, how can I help?", shouldMatch: false }
            ];

            let allPass = true;
            testMessages.forEach(test => {
                const matches = limitPatterns.some(p => p.test(test.text));
                const pass = matches === test.shouldMatch;
                if (!pass) allPass = false;
                log(`  "${test.text.substring(0, 30)}..." - ${pass ? 'åŒ¹é…æ­£ç¡®' : 'åŒ¹é…é”™è¯¯'}`);
            });

            addTestResult('é™åˆ¶æ£€æµ‹æ­£åˆ™è¡¨è¾¾å¼', allPass);
            return allPass;
        }

        // æµ‹è¯•5: æ¢å¤æ—¶é—´è§£æ
        function testResetTimeParsing() {
            log('å¼€å§‹æµ‹è¯•æ¢å¤æ—¶é—´è§£æ...');

            function parseResetTime(message) {
                const hourMatch = message.match(/(\d+)\s*(hour|å°æ—¶)/i);
                const minMatch = message.match(/(\d+)\s*(minute|åˆ†é’Ÿ)/i);

                let resetMs = 0;
                if (hourMatch) resetMs += parseInt(hourMatch[1]) * 60 * 60 * 1000;
                if (minMatch) resetMs += parseInt(minMatch[1]) * 60 * 1000;

                return resetMs;
            }

            const tests = [
                { msg: "Please wait 5 hours", expected: 5 * 60 * 60 * 1000 },
                { msg: "Try again in 30 minutes", expected: 30 * 60 * 1000 },
                { msg: "ç­‰å¾…2å°æ—¶30åˆ†é’Ÿ", expected: 2.5 * 60 * 60 * 1000 }
            ];

            let allPass = true;
            tests.forEach(test => {
                const result = parseResetTime(test.msg);
                const pass = result === test.expected;
                if (!pass) allPass = false;
                log(`  "${test.msg}" -> ${result}ms (æœŸæœ›: ${test.expected}ms) - ${pass ? 'é€šè¿‡' : 'å¤±è´¥'}`);
            });

            addTestResult('æ¢å¤æ—¶é—´è§£æ', allPass);
            return allPass;
        }

        // æµ‹è¯•6: çŠ¶æ€è·å–
        function testStatusRetrieval() {
            log('å¼€å§‹æµ‹è¯•çŠ¶æ€è·å–...');

            const mockUsageData = {
                isLimited: true,
                estimatedResetTime: Date.now() + 3600000,
                messageCount: 25,
                sessionStartTime: Date.now() - 1800000,
                dailyStats: {
                    [new Date().toDateString()]: { messages: 30, limits: 1 }
                },
                limitMessage: 'Test limit'
            };

            const status = {
                isLimited: mockUsageData.isLimited,
                remainingTime: Math.max(0, mockUsageData.estimatedResetTime - Date.now()),
                messageCount: mockUsageData.messageCount,
                todayMessages: mockUsageData.dailyStats[new Date().toDateString()]?.messages || 0
            };

            const pass = status.isLimited === true &&
                         status.remainingTime > 0 &&
                         status.messageCount === 25 &&
                         status.todayMessages === 30;

            addTestResult('çŠ¶æ€è·å–åŠŸèƒ½', pass);
            log(`çŠ¶æ€: isLimited=${status.isLimited}, remaining=${status.remainingTime}, msgs=${status.messageCount}`);

            return pass;
        }

        // æµ‹è¯•7: UI åˆ›å»º
        function testUICreation() {
            log('å¼€å§‹æµ‹è¯•UIåˆ›å»º...');

            // åˆ›å»ºæµ‹è¯•é¢æ¿
            const panel = document.createElement('div');
            panel.id = 'weiruan-test-panel';
            panel.innerHTML = '<div class="header">æµ‹è¯•é¢æ¿</div><div class="body">å†…å®¹</div>';
            document.body.appendChild(panel);

            const created = document.getElementById('weiruan-test-panel') !== null;
            const hasContent = panel.querySelector('.header') !== null;

            // æ¸…ç†
            panel.remove();

            const pass = created && hasContent;
            addTestResult('UI é¢æ¿åˆ›å»º', pass);
            log(`UIåˆ›å»ºæµ‹è¯•: é¢æ¿åˆ›å»º=${created}, å†…å®¹æ­£ç¡®=${hasContent}`);

            return pass;
        }

        // æµ‹è¯•8: å¯¼å‡ºåŠŸèƒ½
        function testExportFunction() {
            log('å¼€å§‹æµ‹è¯•å¯¼å‡ºåŠŸèƒ½...');

            const data = {
                exportTime: new Date().toISOString(),
                version: '1.0.0',
                currentStatus: { isLimited: false, messageCount: 10 },
                dailyStats: { '2024-01-15': { messages: 50, limits: 2 } }
            };

            const jsonString = JSON.stringify(data, null, 2);
            const parsed = JSON.parse(jsonString);

            const pass = parsed.version === '1.0.0' &&
                         parsed.currentStatus.messageCount === 10 &&
                         parsed.dailyStats['2024-01-15'].messages === 50;

            addTestResult('æ•°æ®å¯¼å‡ºåŠŸèƒ½', pass);
            log(`å¯¼å‡ºæµ‹è¯•: JSONç”Ÿæˆ=${jsonString.length}å­—èŠ‚`);

            return pass;
        }

        // ==================== äº¤äº’æµ‹è¯• ====================

        function simulateMessage() {
            log('æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯...');
            const count = parseInt(GM_getValue('message_count', '0')) + 1;
            GM_setValue('message_count', count.toString());
            log(`æ¶ˆæ¯è®¡æ•°æ›´æ–°: ${count}`);
            GM_notification({ title: 'æ¶ˆæ¯å‘é€', text: `ç¬¬ ${count} æ¡æ¶ˆæ¯å·²å‘é€` });
        }

        function simulateRateLimit() {
            log('æ¨¡æ‹Ÿè§¦å‘é€Ÿç‡é™åˆ¶...');
            const resetTime = Date.now() + 5 * 60 * 60 * 1000;
            GM_setValue('is_limited', 'true');
            GM_setValue('reset_time', resetTime.toString());
            GM_notification({ title: 'âš ï¸ é™åˆ¶è§¦å‘', text: 'æ‚¨å·²è¾¾åˆ°ä½¿ç”¨é™åˆ¶ï¼Œé¢„è®¡5å°æ—¶åæ¢å¤' });
            log(`é™åˆ¶å·²è®¾ç½®ï¼Œæ¢å¤æ—¶é—´: ${new Date(resetTime).toLocaleString()}`);
        }

        function simulateReset() {
            log('æ¨¡æ‹Ÿé™åˆ¶æ¢å¤...');
            GM_setValue('is_limited', 'false');
            GM_setValue('reset_time', '0');
            GM_notification({ title: 'âœ… é™åˆ¶å·²æ¢å¤', text: 'æ‚¨ç°åœ¨å¯ä»¥ç»§ç»­ä½¿ç”¨ Claude äº†ï¼' });
            log('é™åˆ¶çŠ¶æ€å·²é‡ç½®');
        }

        function resetAllTests() {
            testResults = [];
            outputLog = [];
            storage['message_count'] = '0';
            storage['is_limited'] = 'false';
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-output').textContent = '[ç­‰å¾…æµ‹è¯•æ‰§è¡Œ...]';
            document.getElementById('summary').innerHTML = '';
            log('æ‰€æœ‰æµ‹è¯•å·²é‡ç½®');
        }

        // ==================== æ‰§è¡Œæµ‹è¯• ====================

        function runAllTests() {
            log('========================================');
            log('å¼€å§‹æ‰§è¡Œå¨è½¯Claudeç”¨é‡æ£€æµ‹æµ‹è¯•å¥—ä»¶');
            log('ç‰ˆæœ¬: 1.0.0');
            log('æ—¶é—´: ' + new Date().toLocaleString());
            log('========================================\n');

            testUtils();
            testStorage();
            testUsageDataStructure();
            testLimitDetection();
            testResetTimeParsing();
            testStatusRetrieval();
            testUICreation();
            testExportFunction();

            log('\n========================================');
            const passed = testResults.filter(t => t.passed).length;
            const total = testResults.length;
            log(`æµ‹è¯•å®Œæˆ: ${passed}/${total} é€šè¿‡`);
            log('========================================');
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæµ‹è¯•
        window.onload = runAllTests;
    </script>
</body>
</html>
